name: CI

on:
  push:

concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}

jobs:
  build-macos:
    name: Build DMG and Upload
    runs-on: macos-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - uses: actions/checkout@v6

      # 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º –ø–µ—Ä–µ–¥–∞–Ω
      - name: Check IDENTITY_P12 secret
        run: |
          if [ -z "${{ secrets.IDENTITY_P12 }}" ]; then
            echo "ERROR: SECRET IDENTITY_P12 IS EMPTY!"
            exit 1
          else
            echo "SECRET IDENTITY_P12 is present"
          fi

      # 3Ô∏è‚É£ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π keychain
      - name: Import code signing certificates
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IDENTITY_P12 }}
          p12-password: ${{ secrets.IDENTITY_P12_PASSWORD }}
          keychain: signing_temp
          create-keychain: true

      # 4Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤
      - name: Clean, strip, and sign binaries
        run: python3 ci.py

      # 5Ô∏è‚É£ –ü–æ–º–µ—á–∞–µ–º –ø–∞–ø–∫—É –∫–∞–∫ –≥–æ—Ç–æ–≤—É—é
      - name: Tag folder
        run: touch Universal-Binaries/.signed

      # 6Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º DMG –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
      - name: Build DMG
        run: python3 Generate-DMG.command --sign

      # 7Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º sha256 —Å—É–º–º—ã
      - name: Generate Checksums
        run: shasum -a 256 Universal-Binaries.dmg > sha256sum.txt

      # 8Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º DMG –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Upload DMG to Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: Universal Binaries
          path: Universal-Binaries.dmg

      # 9Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º sha256sum.txt –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Upload Checksums to Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: sha256sum.txt
          path: sha256sum.txt

      # üîü –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞–ø–∫–∏ deploy –¥–ª—è —Ä–µ–ª–∏–∑–∞
      - run: |
          mkdir deploy
          mv Universal-Binaries.dmg sha256sum.txt deploy/
